<div class="encashment-container container mt-4">
  <div class="header d-flex justify-content-between align-items-center mb-4">
    <h2>Leave Encashment</h2>
    <button class="btn btn-secondary" (click)="goBack()">← Back to Dashboard</button>
  </div>

  <div *ngIf="currentUser" class="encashment-form card p-4 mb-4">
    <div class="info-section alert alert-info mb-4">
      <h3 class="alert-heading">Encashment Policy</h3>
      <div class="policy-info">
        <ul>
          <li>Only Earned Leave (EL) and Unpaid Earned Leave (UEL) are eligible for encashment</li>
          <li>Maximum 15 days can be encashed at once</li>
          <li>Encashment is processed at basic salary rate per day</li>
          <li>Minimum balance must be maintained after encashment</li>
        </ul>
      </div>
    </div>

    <form (ngSubmit)="onSubmit()" #encashmentForm="ngForm">
      <div class="form-group mb-3">
        <label for="leaveType" class="form-label">Select Leave Type for Encashment*</label>
        <select
          id="leaveType"
          [(ngModel)]="formData.leaveType"
          name="leaveType"
          required
          (change)="onLeaveTypeChange()"
          class="form-select">
          <option value="">Select Leave Type</option>
          <option value="EL">Earned Leave (EL) - {{currentUser.leaveBalance.el}} days available</option>
          <option value="UEL">Unpaid Earned Leave (UEL) - {{currentUser.leaveBalance.uel}} days available</option>
        </select>
      </div>

      <div *ngIf="formData.leaveType" class="balance-info mb-3">
        <div class="balance-card card bg-light">
          <div class="card-body">
            <h4 class="card-title">Current Balance: {{getCurrentBalance()}} days</h4>
            <p class="card-text">Maximum encashable: {{maxEncashableDays}} days</p>
            <p class="card-text">Minimum balance to maintain: {{minBalance}} days</p>
          </div>
        </div>
      </div>

      <div class="form-group mb-3">
        <label for="daysToEncash" class="form-label">Days to Encash*</label>
        <input
          type="number"
          id="daysToEncash"
          [(ngModel)]="formData.daysToEncash"
          name="daysToEncash"
          required
          [min]="1"
          [max]="maxEncashableDays"
          (input)="calculateAmount()"
          class="form-control"
          placeholder="Enter number of days">
      </div>

      <div *ngIf="formData.daysToEncash > 0" class="calculation-section mb-3">
        <div class="calculation-card card border-warning">
          <div class="card-body">
            <h4 class="card-title text-warning">Encashment Calculation</h4>
            <div class="calc-row d-flex justify-content-between">
              <span>Days to encash:</span>
              <span>{{formData.daysToEncash}}</span>
            </div>
            <div class="calc-row d-flex justify-content-between">
              <span>Rate per day:</span>
              <span>₹{{dailyRate | number}}</span>
            </div>
            <hr>
            <div class="calc-row total d-flex justify-content-between font-weight-bold">
              <span><strong>Total Amount:</strong></span>
              <span><strong>₹{{totalAmount | number}}</strong></span>
            </div>
            <div class="calc-row d-flex justify-content-between">
              <span>Balance after encashment:</span>
              <span>{{getCurrentBalance() - formData.daysToEncash}} days</span>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="validationMessage" class="validation-message alert" [ngClass]="{'alert-danger': !canEncash, 'alert-success': canEncash}">
        {{validationMessage}}
      </div>

      <div class="form-actions d-flex justify-content-end gap-2">
        <button type="button" class="btn btn-secondary" (click)="resetForm()">Reset</button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="!encashmentForm.valid || !canEncash">
          Submit Encashment Request
        </button>
      </div>
    </form>
  </div>

  <div class="encashment-history card p-4">
    <div class="card-body">
      <h3 class="card-title">Recent Encashment Requests</h3>
      <div class="history-table mt-3">
        <div class="table-responsive">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Leave Type</th>
                <th>Days</th>
                <th>Amount</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let request of encashmentHistory">
                <td>{{request.leaveType}}</td>
                <td>{{request.daysToEncash}}</td>
                <td>₹{{request.amount | number}}</td>
                <td>{{request.appliedDate | date:'dd MMM yyyy'}}</td>
                <td><span class="status badge" [ngClass]="{'bg-warning': request.status === 'pending', 'bg-success': request.status === 'approved', 'bg-danger': request.status === 'rejected'}">{{request.status | titlecase}}</span></td>
              </tr>
              <tr *ngIf="encashmentHistory.length === 0">
                <td colspan="5" class="text-center text-muted">No encashment requests found</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
